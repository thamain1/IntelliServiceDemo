# Google Maps API Key Fix

## Issue

The Google Maps JavaScript API was not loading correctly because the API key was not being included in the script request URL. This resulted in errors like:
- "NoApiKeys" error
- "ApiProjectMapError"
- Map failing to load

## Root Cause

The `@googlemaps/js-api-loader` package expects specific parameter names when calling `setOptions()`:
- `key` (not `apiKey`) - The API key
- `v` (not `version`) - The API version

Our code was using incorrect parameter names:
```typescript
// INCORRECT (before fix)
setOptions({
  apiKey,           // ❌ Wrong - should be 'key'
  version: 'weekly' // ❌ Wrong - should be 'v'
});
```

## Fix Applied

Updated `src/lib/googleMapsLoader.ts` to use the correct parameter names:

```typescript
// CORRECT (after fix)
setOptions({
  key: apiKey,      // ✅ Correct parameter name
  v: 'weekly'       // ✅ Correct parameter name
});
```

## How It Works

The `@googlemaps/js-api-loader` bootstrap process:

1. `setOptions()` is called with configuration
2. When `importLibrary()` is first called, it triggers the bootstrap
3. Bootstrap creates a `<script>` tag with URL: `https://maps.googleapis.com/maps/api/js`
4. Parameters are converted to query string (e.g., `key` → `?key=YOUR_KEY`, `v` → `&v=weekly`)
5. Libraries are added to the request (e.g., `&libraries=maps,marker`)
6. The final URL looks like: `https://maps.googleapis.com/maps/api/js?key=AIza...&v=weekly&libraries=maps,marker&callback=google.maps.__ib__`

## Verification

To verify the fix is working:

1. **Open DevTools** (F12 in most browsers)
2. **Go to the Network tab**
3. **Navigate to the Call Map page**
4. **Look for a request to** `maps.googleapis.com/maps/api/js`
5. **Verify the URL includes:** `?key=AIza...` (your actual API key)

### Console Logs

Enhanced logging has been added to help debug:
```
[Google Maps] API Key check: Key is present
[Google Maps] API Key length: 39
[Google Maps] First 10 chars: AIzaSyBEw5
[Google Maps] Setting options with key: AIzaSyBEw5...
[Google Maps] Loading maps library...
[Google Maps] Loading marker library...
[Google Maps] All libraries loaded successfully
[Google Maps] Verify the request URL includes: ?key=AIzaSyBEw5...
```

If you see these logs in order without errors, the API is loading correctly.

## COEP Warnings

You may see console warnings about Cross-Origin-Embedder-Policy (COEP):
```
The resource from "https://googletagmanager.com/.../sw_iframe.html" was blocked
due to COEP
```

**These warnings can be safely ignored:**
- They do not prevent the map from loading
- They are generated by Google's internal tracking/analytics
- The map functionality is not affected

If you need to eliminate these warnings for compliance reasons:
- Remove or scope COEP headers in your hosting configuration
- Or exclude Google Maps routes from COEP-protected pages

## Testing

After deployment:
1. Navigate to the Call Map page
2. Map should load and display properly
3. Check Network tab to confirm `?key=` is in the API request
4. Verify no "NoApiKeys" or "ApiProjectMapError" in console
5. COEP warnings are expected and harmless

## Related Files

- `src/lib/googleMapsLoader.ts` - Fixed API key injection
- `src/components/Mapping/CallMapGoogle.tsx` - Map component (unchanged)
- `.env` - Contains `VITE_GOOGLE_MAPS_API_KEY`
- `GOOGLE_MAPS_INTEGRATION.md` - Updated documentation

## No Breaking Changes

This fix only corrects the parameter names passed to `setOptions()`. No other changes were made:
- No database schema changes
- No changes to other components
- No changes to RLS policies
- Map functionality remains identical
- All other features continue to work normally
